import{Ra as f,Sa as c,k as w,l as m}from"./chunk-UC44CHGE.js";import{K as h,N as u,S as l,a as g,b as v,c as _,d as I,ea as p,o as i,y as n}from"./chunk-J75BIECF.js";var d=class extends Error{};d.prototype.name="InvalidTokenError";function $(o){return decodeURIComponent(atob(o).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function D(o){let e=o.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return $(e)}catch{return atob(e)}}function E(o,e){if(typeof o!="string")throw new d("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=o.split(".")[t];if(typeof r!="string")throw new d(`Invalid token specified: missing part #${t+1}`);let s;try{s=D(r)}catch(a){throw new d(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(s)}catch(a){throw new d(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var U=class o{http=l(m);errorText=l(f);currentUserSource=p(null);currentUser=this.currentUserSource.asReadonly();constructor(){this.loadUserFromStorage()}toDto(e){return{email:e.email,password:e.password}}signIn$(e){let t=this.toDto(e);return this.http.post(c.authUrl+"login",t).pipe(h(r=>{this.handleLogin(r.access_token)}),n(r=>i(()=>new Error(this.errorText.get(r,"Auth")))))}handleLogin(e){return I(this,null,function*(){try{localStorage.setItem("access_token",e);let t=yield E(e),r=g({id:t.sub},t);this.currentUserSource.set(r)}catch(t){console.error("Error al decodificar el token",t),this.handleLogout()}})}loadUserFromStorage(){let e=localStorage.getItem("access_token");e&&this.handleLogin(e)}handleLogout(){localStorage.removeItem("access_token"),this.currentUserSource.set(null)}isAuthenticated(){return!!localStorage.getItem("access_token")}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};var b=class o{http=l(m);errorText=l(f);toDto(e){let a=e,{id:t}=a,r=_(a,["id"]);return v(g({},r),{birthdate:e.birthdate?new Date(e.birthdate).toISOString():null})}getCoachees$(){let e=new w;return e=e.append("relations","processes"),this.http.get(c.coacheesUrl,{params:e}).pipe(n(t=>i(()=>new Error(this.errorText.get(t,"Coachee")))))}getCoachee$(e){return this.http.get(c.coacheesUrl+e).pipe(n(t=>i(()=>new Error(this.errorText.get(t,"Coachee")))))}createCoachee$(e,t){let r=this.toDto(t);return this.http.post(c.coacheesUrl+e,r).pipe(n(s=>i(()=>new Error(this.errorText.get(s,"Coachee")))))}updateCoachee$(e,t){let r=this.toDto(t);return this.http.put(c.coacheesUrl+e,r).pipe(n(s=>i(()=>new Error(this.errorText.get(s,"Coachee")))))}deleteCoachee$(e){return this.http.delete(c.coacheesUrl+e).pipe(n(t=>i(()=>new Error(this.errorText.get(t,"Coachee")))))}removeCoachee$(e){return this.http.patch(c.coacheesUrl+e+"/remove","").pipe(n(t=>i(()=>new Error(this.errorText.get(t,"Coachee")))))}restoreCoachee$(e){return this.http.patch(c.coacheesUrl+e+"/restore","").pipe(n(t=>i(()=>new Error(this.errorText.get(t,"Coachee")))))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};var x=class o{api=l(b);_coachees=p([]);_coachee=p(void 0);coachees=this._coachees.asReadonly();coachee=this._coachee.asReadonly();_error=p(null);error=this._error.asReadonly();_loading=p(!1);loading=this._loading.asReadonly();getCoachees(){this._loading.set(!0),this._error.set(null),this.api.getCoachees$().subscribe({next:e=>{this._coachees.set(e),this._loading.set(!1)},error:e=>{this._error.set(e.message),this._loading.set(!1)}})}getCoachee(e){this._loading.set(!0),this._error.set(null),this.api.getCoachee$(e).subscribe({next:t=>{this._coachee.set(t),this._loading.set(!1)},error:t=>{this._error.set(t.message),this._loading.set(!1)}})}createCoachee(e,t){this._loading.set(!0),this._error.set(null),this.api.createCoachee$(e,t).pipe(h({next:r=>{let s=r;this._coachees.update(a=>[...a,s]),this._loading.set(!1)},error:r=>{this._error.set(r.message),this._loading.set(!1)}})).subscribe()}createCoachee$(e,t){return this.api.createCoachee$(e,t)}updateCoachee(e,t){this._loading.set(!0),this._error.set(null),this.api.updateCoachee$(e,t).pipe(h({next:r=>{let s=r;this._coachees.update(a=>a.map(C=>C.id===e?s:C)),this._loading.set(!1)},error:r=>{this._error.set(r.message),this._loading.set(!1)}})).subscribe()}updateCoachee$(e,t){return this.api.updateCoachee$(e,t)}deleteCoachee(e){this._loading.set(!0),this._error.set(null),this.api.deleteCoachee$(e).pipe(h({next:()=>{this._coachees.update(t=>t.filter(r=>r.id!==e)),this._loading.set(!1)},error:t=>{this._error.set(t.message),this._loading.set(!1)}})).subscribe()}removeCoachee(e){this._loading.set(!0),this._error.set(null),this.api.removeCoachee$(e).pipe(h({next:()=>{this._coachees.update(t=>t.filter(r=>r.id!==e)),this._loading.set(!1)},error:t=>{this._error.set(t.message),this._loading.set(!1)}})).subscribe()}restoreCoachee(e){this._loading.set(!0),this._error.set(null),this.api.restoreCoachee$(e).pipe(h({next:t=>{this._loading.set(!1)},error:t=>{this._error.set(t.message),this._loading.set(!1)}})).subscribe()}clearError(){this._error.set(null)}clearCoachee(){this._coachee.set(void 0)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};export{U as a,x as b};
